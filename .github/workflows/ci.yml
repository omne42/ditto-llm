name: ci

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  node:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout ditto-llm
        uses: actions/checkout@v4
        with:
          path: ditto-llm

      - name: Install Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"
          cache-dependency-path: ditto-llm/pnpm-lock.yaml

      - name: Enable corepack
        working-directory: ditto-llm
        run: corepack enable

      - name: Install pnpm
        working-directory: ditto-llm
        run: corepack prepare pnpm@10.28.2 --activate

      - name: pnpm install
        working-directory: ditto-llm
        run: pnpm install --frozen-lockfile

      - name: pnpm typecheck
        working-directory: ditto-llm
        run: pnpm run typecheck

      - name: pnpm build
        working-directory: ditto-llm
        run: pnpm run build

  rust:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout ditto-llm
        uses: actions/checkout@v4
        with:
          path: ditto-llm

      - name: Install Rust
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: 1.85.0
          components: rustfmt, clippy

      - name: Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: |
            ditto-llm -> target

      - name: cargo fmt
        working-directory: ditto-llm
        run: cargo fmt -- --check

      - name: llms.txt up to date
        working-directory: ditto-llm
        run: cargo run --bin ditto-llms-txt -- --check

      - name: cargo clippy (all features)
        working-directory: ditto-llm
        run: cargo clippy --all-targets --all-features -- -D warnings

      - name: cargo test (all features)
        working-directory: ditto-llm
        run: cargo test --all-targets --all-features

      - name: cargo check (no default features)
        working-directory: ditto-llm
        run: cargo check --no-default-features

      - name: cargo clippy (no default features)
        working-directory: ditto-llm
        run: cargo clippy --no-default-features -- -D warnings

      - name: cargo clippy (no default features + openai)
        working-directory: ditto-llm
        run: cargo clippy -p ditto-llm --no-default-features --features openai --all-targets -- -D warnings

      - name: cargo clippy (no default features + openai-compatible)
        working-directory: ditto-llm
        run: cargo clippy -p ditto-llm --no-default-features --features openai-compatible --all-targets -- -D warnings
